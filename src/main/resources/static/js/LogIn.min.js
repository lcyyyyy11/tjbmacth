clearListCookies();$(function(){loadValiCode();formValidator();$("#ReloadCode").click(function(){loadValiCode()});function loadValiCode(){var img=document.getElementById("ImgValidCode");var url=img.getAttribute("authSrc");var request=new XMLHttpRequest();request.responseType="blob";request.open("get",url,true);request.onreadystatechange=function(e){if((request.readyState===XMLHttpRequest.DONE)&&request.status===200){img.src=URL.createObjectURL(request.response);img.onload=function(){URL.revokeObjectURL(img.src)}}};request.send(null)}function formValidator(){$("#loginform").bootstrapValidator({message:"This value is not valid",feedbackIcons:{valid:"glyphicon glyphicon-ok text-white",invalid:"glyphicon glyphicon-remove text-white",validating:"glyphicon glyphicon-refresh text-white"},fields:{User:{validators:{notEmpty:{message:"请填写用户名"}}},Pwd:{validators:{notEmpty:{message:"请填写密码"}}},VerifyCode:{threshold:4,validators:{notEmpty:{message:"请填写验证码"},callback:{message:"验证码错误",callback:function(value,validator){if(value){return getVerCodeFlag(value)}return true}}}}}}).on("success.form.bv",function(e){e.preventDefault();var $form=$(e.target);$form.data("bootstrapValidator");uLogin()})}function getVerCodeFlag(val){var t;$.ajax({type:"POST",url:"/user/loginVerify/cVilidCode",data:{ImgCode:val.trim()},async:false,dataType:"json",success:function(d){t=(d.valid)}});return t}function uLogin(){var encryptObj=new JSEncrypt();$.ax("/user/loginVerify/public_key",{},true,"POST","json","",function(d,textStatus,resObj){if(d.PublicKey){var publicKey=d.PublicKey;var timeStamp=d.TimeStamp;encryptObj.setPublicKey(publicKey);var user=$.trim($("#User").val());var psw=$.trim($("#Pwd").val());window.localStorage.clear();$.ax("/user/loginVerify/login",{user:user,passWord:encryptObj.encrypt(psw),TimeStamp:timeStamp},false,"POST","text",function(reqObj,settings){},function(d,textStatus,resObj){var msg=$.parseJSON(d).msg;if(msg.indexOf("成功")>-1){setGlobalVar("YUserName",decodeURI(resObj.getResponseHeader("YUserName")));setGlobalVar("YLoginId",resObj.getResponseHeader("YLoginId"));setGlobalVar("YRole",resObj.getResponseHeader("YRole"));setGlobalVar("YRoleName",decodeURI(resObj.getResponseHeader("YRoleName")));eval($.parseJSON(d).data)}else{RunPop("提示信息","",$.parseJSON(d).data,"提示",0.4,0.2,"","U1");$("#loginBtn").attr("disabled",false);loadValiCode();$("#loginform").data("bootstrapValidator").updateStatus("VerifyCode","callback").validateField("VerifyCode")}},function(resObj,textStatus,errorThrown){alert(resObj.responseText);$("#loginBtn").attr("disabled",false)},function(resObj,textStatus){})}else{alert(resObj.responseText);$("#loginBtn").attr("disabled",false)}},function(resObj,textStatus,errorThrown){alert(resObj.responseText);$("#loginBtn").attr("disabled",false)},function(resObj,textStatus){})}});